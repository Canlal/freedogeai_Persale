<!DOCTYPE html>
<html>
<head>
    <title>MetaMask Fix</title>
    <script>
    // 1. META MASK İÇİN RADİKAL TEMİZLİK
    function resetMetaMask() {
        if (!window.ethereum) return;
        
        // Internal state'i sıfırla
        window.ethereum._state = {
            accounts: null,
            isConnected: false,
            isUnlocked: false,
            initialized: false
        };
        
        // Bekleyen tüm istekleri iptal et
        if (window.ethereum._metamask) {
            window.ethereum._metamask.isUnlocked = () => Promise.resolve(false);
            window.ethereum._metamask._requests = new Map();
        }
        
        // Event listener'ları temizle
        window.ethereum.removeAllListeners?.();
    }

    // 2. TEMİZ BAĞLANTI FONKSİYONU
    async function connectWallet() {
        // ÖNCE MUTLAKA RESET
        resetMetaMask();
        
        try {
            // SADECE META MASK KONTROLÜ
            if (!window.ethereum?.isMetaMask) {
                if (confirm("MetaMask yüklü değil! Yükleme sayfasına gidilsin mi?")) {
                    window.open("https://metamask.io/download.html", "_blank");
                }
                return;
            }

            // YENİ İSTEK (ZAMAN AŞIMLI)
            const accounts = await Promise.race([
                window.ethereum.request({ 
                    method: 'eth_requestAccounts',
                    params: [] 
                }),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Zaman aşımı")), 8000)
                )
            ]);

            // BAŞARI DURUMU
            alert(`Bağlı cüzdan: ${accounts[0].slice(0,6)}...${accounts[0].slice(-4)}`);

        } catch (error) {
            console.error("Hata:", error);
            resetMetaMask(); // HATA OLURSA TEKRAR RESET
            
            if (error.code === 4001) {
                alert("Bağlantı reddedildi. Yeniden denemek için butona basın.");
            } else {
                alert(`Hata: ${error.message}\nLütfen sayfayı yenileyin.`);
            }
        }
    }
    </script>
</head>
<body>
    <button onclick="connectWallet()" 
            style="padding:12px 24px; background:#f6851b; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px;">
        META MASK'E BAĞLAN
    </button>

    <script>
    // SAYFA AÇILIRKEN EK ÖNLEM
    window.addEventListener('load', () => {
        resetMetaMask();
        if (window.ethereum) {
            window.ethereum.autoRefreshOnNetworkChange = false;
        }
    });
    </script>
</body>
</html>
