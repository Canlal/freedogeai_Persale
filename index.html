<!DOCTYPE html>
<html>
<head>
    <title>FreeDogeAI Fix</title>
    <script>
    // 1. TÜM BEKLEYEN İSTEKLERİ KÖKTEN TEMİZLE
    function resetWallet() {
        if (window.ethereum) {
            // MetaMask'in iç state'ini sıfırla
            if (window.ethereum._state) {
                window.ethereum._state.accounts = null;
                window.ethereum._state.isConnected = false;
                window.ethereum._state.isUnlocked = false;
            }
            // Tüm event listener'ları kaldır
            if (window.ethereum.removeAllListeners) {
                window.ethereum.removeAllListeners();
            }
            // Tüm bekleyen istekleri iptal et
            if (window.ethereum._metamask) {
                window.ethereum._metamask.isUnlocked = () => Promise.resolve(false);
            }
        }
    }

    // 2. YENİ BAĞLANTI FONKSİYONU
    async function connectWallet() {
        resetWallet(); // Önce her şeyi sıfırla
        
        try {
            if (!window.ethereum) {
                throw new Error("Cüzdan bulunamadı");
            }

            // YENİ BİR İSTEK BAŞLAT (ZAMAN AŞIMLI)
            const accounts = await Promise.race([
                window.ethereum.request({ method: 'eth_requestAccounts' }),
                new Promise((_, reject) => setTimeout(() => reject(new Error("Zaman aşımı")), 5000))
            ]);

            const shortAddr = accounts[0].substring(0,6) + "..." + accounts[0].substring(38);
            alert("BAĞLANDI: " + shortAddr);

        } catch (error) {
            console.error("HATA:", error);
            alert("HATA: " + (error.message || "Bağlantı başarısız"));
            resetWallet(); // Hata durumunda tekrar sıfırla
        }
    }
    </script>
</head>
<body>
    <h1>FreeDogeAI Presale</h1>
    <button onclick="connectWallet()" 
            style="padding:12px 24px; background:#2b6cb0; color:white; border:none; border-radius:8px; cursor:pointer;">
        CONNECT WALLET
    </button>
</body>
</html>
