<script>
// TÜM BEKLEYEN İSTEKLERİ SIFIRLA
if (window.ethereum) {
  window.ethereum.removeAllListeners();
  if (window.ethereum._state) {
    window.ethereum._state.accounts = null;
    window.ethereum._state.isConnected = false;
  }
}

// BASİT BAĞLANTI FONKSİYONU
async function connectWallet() {
  try {
    // Eğer cüzdan yoksa uyar
    if (!window.ethereum) {
      window.open("https://metamask.io/download.html", "_blank");
      throw new Error("Cüzdan uzantısı bulunamadı");
    }

    // BEKLEYEN İSTEKLERİ TEMİZLE (2. KORUMA KATMANI)
    if (window.ethereum.request) {
      await window.ethereum.request({ method: 'wallet_requestPermissions', params: [] });
    }

    // HESAPLARI AL
    const accounts = await window.ethereum.request({ 
      method: 'eth_requestAccounts',
      params: [] // Boş params ekleyerek çakışmayı önle
    });

    // BAŞARILI MESAJI
    const shortAddress = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
    console.log("Connected to:", shortAddress);
    alert(`Bağlantı başarılı!\nCüzdan: ${shortAddress}`);

  } catch (error) {
    console.error("Connection error:", error);
    if (error.code === 4001) {
      alert("Bağlantı reddedildi! Lütfen izin verin.");
    } else {
      alert(`Hata: ${error.message || "Bilinmeyen hata"}`);
    }
  }
}

// BUTONLARI AYARLA
document.getElementById('connectMetamaskBtn').onclick = () => {
  window.ethereum = window.ethereum || { isMetaMask: true };
  connectWallet();
};

document.getElementById('connectTrustWalletBtn').onclick = () => {
  if (/Android|iPhone/i.test(navigator.userAgent)) {
    window.location.href = `trust://browser?url=${encodeURIComponent(window.location.href)}`;
  } else {
    connectWallet();
  }
};
</script>
