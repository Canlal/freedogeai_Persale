<!DOCTYPE html>
<html>
<head>
    <title>FreeDogeAI Ultimate Fix</title>
    <script>
    // 1. RADİKAL WALLET RESETLEME
    function nuclearReset() {
        if (window.ethereum) {
            // MetaMask internal state override
            if (window.ethereum._metamask) {
                window.ethereum._metamask.isUnlocked = () => Promise.resolve(false);
                window.ethereum._metamask.isEnabled = () => Promise.resolve(false);
                window.ethereum._metamask._requests = new Map();
            }
            
            // Provider-level reset
            window.ethereum.removeAllListeners?.();
            window.ethereum._state = {
                accounts: null,
                isConnected: false,
                isUnlocked: false,
                initialized: false
            };
            
            // Multi-provider fix
            if (window.ethereum.providers?.length) {
                window.ethereum = window.ethereum.providers[0];
            }
        }
    }

    // 2. BAĞLANTI FONKSİYONU (YENİ NESİL)
    async function connectWallet() {
        // ÖNCE KÖKLÜ TEMİZLİK
        nuclearReset();
        
        try {
            if (!window.ethereum) throw new Error("Cüzdan bulunamadı");
            
            // YENİ BİR İSTEK BAŞLAT
            const accounts = await Promise.race([
                window.ethereum.request({ 
                    method: 'eth_requestAccounts',
                    params: []
                }),
                new Promise((_, reject) => setTimeout(
                    () => reject(new Error("İstek zaman aşımı")), 
                    10000
                ))
            ]);
            
            // BAŞARILI DURUM
            alert(`Bağlantı başarılı!\n${accounts[0].slice(0,6)}...${accounts[0].slice(-4)}`);
            
        } catch (error) {
            console.error("HATA:", error);
            nuclearReset(); // HATA OLURSA TEKRAR RESET
            
            if (error.code === 4001) {
                alert("Bağlantı reddedildi. Yeniden denemek için butona basın.");
            } else {
                alert(`Hata: ${error.message || "Bilinmeyen hata"}\nSayfayı yenileyip tekrar deneyin.`);
            }
        }
    }
    </script>
</head>
<body>
    <h1>FreeDogeAI Presale</h1>
    <button onclick="connectWallet()" 
            style="padding:12px 24px; background:#2b6cb0; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; margin:20px;">
        CONNECT WALLET
    </button>

    <script>
    // SAYFA YÜKLENİRKEN EK ÖNLEMLER
    window.addEventListener('load', () => {
        nuclearReset();
        if (window.ethereum) {
            window.ethereum.autoRefreshOnNetworkChange = false;
            window.ethereum.on('disconnect', nuclearReset);
        }
    });
    </script>
</body>
</html>
