<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Presale</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        /* Tüm stil tanımları önceki koddaki gibi */
    </style>
</head>
<body>
    <!-- Arayüz önceki koddaki gibi -->

    <script>
        // Gelişmiş Cüzdan Bağlantı Sistemi
        async function connectWallet() {
            if (!window.ethereum) {
                // Mobil cihaz kontrolü
                if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                    // MetaMask ve Trust Wallet için universal link
                    window.location.href = "https://metamask.app.link/dapp/" + encodeURIComponent(window.location.href);
                    setTimeout(() => {
                        window.location.href = "https://link.trustwallet.com/open_url?url=" + encodeURIComponent(window.location.href);
                    }, 200);
                } else {
                    alert("Lütfen MetaMask veya Trust Wallet yükleyin!");
                    window.open("https://metamask.io/download.html", "_blank");
                }
                return;
            }

            try {
                // Düzgün bağlantı URL'si oluştur
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete("error");
                window.history.replaceState({}, document.title, currentUrl.toString());

                // Bağlantı isteği
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts',
                    params: [{ eth_chainId: '0x38' }] // BSC için chainId
                });

                userAddress = accounts[0];
                web3 = new Web3(window.ethereum);

                // Ağ kontrolü
                await checkNetwork();
                await updateWalletInfo();

            } catch (error) {
                console.error("Bağlantı hatası:", error);
                
                // Özel hata yönetimi
                if (error.code === 4001) {
                    alert("Bağlantı reddedildi. Lütfen izin verin.");
                } else if (error.code === -32002) {
                    alert("Zaten bekleyen bir istek var. Lütfen cüzdan uygulamanızı kontrol edin.");
                } else {
                    alert("Bağlantı hatası: " + error.message);
                }
            }
        }

        // Mobil uygulama açma fonksiyonu
        function openWalletApp(walletType) {
            if (walletType === 'metamask') {
                // MetaMask için universal link
                window.location.href = "https://metamask.app.link/dapp/" + encodeURIComponent(window.location.href);
            } else {
                // Trust Wallet için universal link
                window.location.href = "https://link.trustwallet.com/open_url?url=" + encodeURIComponent(window.location.href);
            }
            
            // 3 saniye sonra hala açılmadıysa mağazaya yönlendir
            setTimeout(() => {
                if (!document.hidden) {
                    if (walletType === 'metamask') {
                        window.open("https://metamask.io/download.html", "_blank");
                    } else {
                        window.open("https://trustwallet.com/download", "_blank");
                    }
                }
            }, 3000);
        }

        // Ağ kontrolü (güncellendi)
        async function checkNetwork() {
            try {
                const chainId = await web3.eth.getChainId();
                if (chainId !== 56) {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x38' }]
                    });
                }
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x38',
                            chainName: 'Binance Smart Chain',
                            nativeCurrency: { 
                                name: 'BNB', 
                                symbol: 'BNB', 
                                decimals: 18 
                            },
                            rpcUrls: ['https://bsc-dataseed.binance.org/'],
                            blockExplorerUrls: ['https://bscscan.com/']
                        }]
                    });
                }
            }
        }
    </script>
</body>
</html>
